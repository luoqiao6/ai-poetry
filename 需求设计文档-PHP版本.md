# AI诗词推荐和赏析应用 - 详细需求设计文档（PHP版本）

## 1. 项目概述

### 1.1 项目背景
开发一个基于AI大模型的诗词推荐和赏析应用，通过AI技术为用户提供个性化的诗词推荐和深度赏析服务。

### 1.2 项目目标
- 利用AI大模型能力，根据用户需求智能推荐相关诗词
- 提供诗词的深度赏析和解读
- 支持多平台客户端访问
- 提供完善的后台管理系统

### 1.3 系统架构概览
```
┌─────────────┐
│   客户端    │ (移动端/PC端)
└──────┬──────┘
       │ HTTP/HTTPS
┌──────▼──────────────────┐
│    应用API接口层         │
└──────┬──────────────────┘
       │
┌──────▼──────────────────┐
│    Web后台管理系统       │
└──────┬──────────────────┘
       │
┌──────▼──────────────────┐
│  AI诗词推荐Agent程序     │
└──────┬──────────────────┘
       │
┌──────▼──────────────────┐
│    AI大模型API接口       │
└─────────────────────────┘
       │
┌──────▼──────────────────┐
│      数据库              │
└─────────────────────────┘
```

---

## 2. 第一部分：AI 诗词推荐程序（AI 诗词推荐 Agent）

### 2.1 功能概述
在服务器上运行的后台命令行程序，作为AI Agent，负责调用AI大模型接口获取诗词推荐和赏析内容，并将结果保存到数据库。

### 2.2 核心功能需求

#### 2.2.1 命令行接口
- **程序入口**：支持命令行参数输入
- **参数列表**：
  - `--prompt` / `-p`: 正向提示词（必填，至少提供正向提示词或图片之一）
    - 描述用户希望推荐的诗词应包含的内容、主题、情感等
    - 例如："关于春天的诗"、"表达思乡之情的诗词"
  - `--negative-prompt` / `-np`: 负向提示词（可选）
    - 描述用户不希望推荐的诗词包含的内容
    - 推荐的诗词不能包含负向提示词中的内容
    - 例如："不要包含悲伤情绪"、"不要推荐现代诗"
  - `--image` / `-i`: 图片文件路径（可选，至少提供正向提示词或图片之一）
    - 支持常见图片格式：JPG、PNG、WEBP等
    - 程序将识别图片内容，推荐与图片内容相符的诗词
    - 可与正向提示词结合使用，提供更精确的推荐
  - `--user-id` / `-u`: 用户ID（可选）
    - 指定推荐记录所属的用户
    - 用于用户个性化推荐和统计
  - `--context` / `-c`: 上下文信息（可选）
    - 额外的上下文信息，如用户偏好、历史推荐等
  - `--model` / `-m`: 指定使用的AI模型（可选，有默认值）
  - `--count` / `-n`: 推荐诗词数量（可选，默认1首）
  - `--type` / `-t`: 推荐类型（推荐/赏析/创作，可选）
  - `--config` / `-f`: 配置文件路径（可选）
  - `--verbose` / `-v`: 详细输出模式（可选）

#### 2.2.2 AI大模型接口调用
- **支持的AI模型**：
  - OpenAI GPT系列
  - 百度文心一言
  - 阿里通义千问
  - 其他主流大模型API
- **提示词工程**：
  - 构建标准化的提示词模板
  - 支持正向提示词和负向提示词
  - 正向提示词：描述期望的诗词特征（主题、情感、风格等）
  - 负向提示词：描述需要排除的诗词特征，确保推荐结果不包含这些内容
  - 支持图片输入和图像识别
    - 使用多模态AI模型（如GPT-4V、Claude等）识别图片内容
    - 将图片内容转换为文本描述，结合正向提示词生成推荐
  - 支持上下文信息注入
  - 支持多轮对话上下文
  - 提示词组合策略：
    - 仅正向提示词：根据正向提示词推荐
    - 正向+负向提示词：根据正向提示词推荐，同时排除负向提示词内容
    - 仅图片：识别图片内容，推荐相符的诗词
    - 图片+正向提示词：结合图片内容和正向提示词，提供更精确的推荐
    - 图片+正向+负向提示词：综合三种输入，提供最精确的推荐
- **请求处理**：
  - 参数验证和格式化
  - API密钥管理
  - 请求重试机制
  - 超时处理
  - 错误处理和日志记录

#### 2.2.3 数据解析与存储
- **图片处理**：
  - 图片文件验证（格式、大小、尺寸）
  - 图片预处理（压缩、格式转换等）
  - 图片存储（本地文件系统或对象存储）
  - 图片内容识别（调用多模态AI模型）
- **响应解析**：
  - 解析AI返回的JSON/文本格式
  - 提取诗词内容、作者、朝代等信息
  - 提取赏析内容
  - 数据清洗和格式化
- **数据库存储**：
  - 保存用户ID（如提供）
  - 保存推荐诗词的完整信息
  - 保存正向提示词和负向提示词
  - 保存图片路径和图片内容描述（如适用）
  - 保存上下文信息
  - 保存AI模型信息
  - 保存请求时间戳
  - 保存请求状态（成功/失败）

#### 2.2.4 执行结果返回
- **返回状态码**：
  - 0: 执行成功
  - 1: 参数错误
  - 2: API调用失败
  - 3: 数据库操作失败
  - 4: 其他错误
- **返回信息**：
  - 成功：返回保存的记录ID和简要信息
  - 失败：返回详细的错误信息

### 2.3 数据模型设计

#### 2.3.1 推荐记录表（recommendations）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键，自增 |
| user_id | BIGINT | 用户ID（外键，关联users表） |
| positive_prompt | TEXT | 正向提示词（用户期望的诗词特征） |
| negative_prompt | TEXT | 负向提示词（需要排除的诗词特征） |
| image_path | VARCHAR(500) | 图片文件路径（如适用） |
| image_description | TEXT | 图片内容描述（AI识别结果） |
| context | TEXT | 上下文信息 |
| poem_title | VARCHAR(200) | 诗词标题 |
| poem_content | TEXT | 诗词内容 |
| author | VARCHAR(100) | 作者 |
| dynasty | VARCHAR(50) | 朝代 |
| appreciation | TEXT | 赏析内容 |
| model_name | VARCHAR(100) | 使用的AI模型 |
| model_version | VARCHAR(50) | 模型版本 |
| status | TINYINT | 状态（1:成功 0:失败） |
| error_message | TEXT | 错误信息（如有） |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**字段说明**：
- `user_id` 用于标识推荐记录所属的用户，支持用户个性化推荐
- `positive_prompt` 和 `image_path` 至少有一个不为空
- `negative_prompt` 可为空，表示无排除要求
- `image_description` 在提供图片时由AI自动生成

### 2.4 技术实现要求
- **编程语言**：PHP 7.4+ / PHP 8.0+
- **依赖库**：
  - `symfony/console`: 命令行参数解析
  - `guzzlehttp/guzzle`: HTTP客户端（AI API调用）
  - `intervention/image` / `gd`: 图片处理
  - `illuminate/database` / `doctrine/dbal` / `PDO`: 数据库操作
  - `vlucas/phpdotenv`: 环境变量管理
  - `monolog/monolog`: 日志记录
  - `base64`: 图片编码（用于API调用，PHP内置）
- **配置文件**：
  - 数据库连接配置
  - AI API密钥配置
  - 模型默认参数配置

### 2.5 使用示例
```bash
# 基本使用 - 仅正向提示词
php poetry_agent.php --prompt "推荐一首关于春天的诗"

# 正向提示词 + 负向提示词
php poetry_agent.php \
  --prompt "推荐一首关于春天的诗" \
  --negative-prompt "不要包含悲伤情绪，不要现代诗"

# 仅图片输入
php poetry_agent.php --image /path/to/image.jpg

# 图片 + 正向提示词
php poetry_agent.php \
  --image /path/to/image.jpg \
  --prompt "推荐一首与图片意境相符的诗词"

# 图片 + 正向提示词 + 负向提示词
php poetry_agent.php \
  --image /path/to/image.jpg \
  --prompt "推荐一首与图片意境相符的诗词" \
  --negative-prompt "不要现代诗"

# 完整参数示例（包含用户ID）
php poetry_agent.php \
  --user-id 1001 \
  --prompt "推荐一首关于春天的诗" \
  --negative-prompt "不要包含悲伤情绪" \
  --image /path/to/image.jpg \
  --context "用户喜欢唐诗" \
  --model "gpt-4" \
  --count 3 \
  --type "推荐" \
  --verbose

# 使用配置文件
php poetry_agent.php --config config.json --prompt "推荐一首诗"

# 为指定用户生成推荐
php poetry_agent.php \
  --user-id 1001 \
  --prompt "推荐一首关于春天的诗"
```

**参数组合规则**：
- 必须至少提供 `--prompt` 或 `--image` 之一
- `--negative-prompt` 可选，用于排除特定内容
- 图片和提示词可以组合使用，提供更精确的推荐

---

## 3. 第二部分：应用API接口

### 3.1 功能概述
提供RESTful API接口，供客户端调用，返回数据库中存储的AI推荐诗词内容。

### 3.2 API接口设计

#### 3.2.0 用户认证接口

##### 3.2.0.1 用户注册
- **接口路径**：`POST /api/v1/auth/register`
- **功能**：用户注册
- **请求参数**：
  - `username`: 用户名（必填）
  - `password`: 密码（必填）
  - `nickname`: 昵称（可选）
  - `email`: 邮箱（可选）
- **响应格式**：
```json
{
  "code": 200,
  "message": "注册成功",
  "data": {
    "user_id": 1001,
    "username": "zhangsan",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

##### 3.2.0.2 用户登录
- **接口路径**：`POST /api/v1/auth/login`
- **功能**：用户登录
- **请求参数**：
  - `username`: 用户名（必填）
  - `password`: 密码（必填）
- **响应格式**：
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "user_id": 1001,
    "username": "zhangsan",
    "nickname": "张三",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expires_in": 3600
  }
}
```

##### 3.2.0.3 用户退出
- **接口路径**：`POST /api/v1/auth/logout`
- **功能**：用户退出登录
- **认证要求**：需要用户认证
- **响应格式**：
```json
{
  "code": 200,
  "message": "退出成功"
}
```

##### 3.2.0.4 获取当前用户信息
- **接口路径**：`GET /api/v1/auth/me`
- **功能**：获取当前登录用户信息
- **认证要求**：需要用户认证
- **响应格式**：同获取用户信息接口

#### 3.2.1 创建推荐请求
- **接口路径**：`POST /api/v1/recommendations`
- **功能**：提交推荐请求，触发AI Agent生成推荐
- **请求格式**：`multipart/form-data` 或 `application/json`
- **认证要求**：需要用户认证（通过token或session）
- **请求参数**：
  - `user_id`: 用户ID（从认证信息中获取，或通过参数传入）
  - `positive_prompt`: 正向提示词（必填，与image至少提供一个）
  - `negative_prompt`: 负向提示词（可选）
  - `image`: 图片文件（可选，与positive_prompt至少提供一个）
  - `context`: 上下文信息（可选）
  - `model`: 指定AI模型（可选）
  - `count`: 推荐数量（可选，默认1）
  - `type`: 推荐类型（可选）
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "task_id": "12345",
    "status": "processing",
    "message": "推荐任务已提交，正在处理中"
  }
}
```

#### 3.2.2 获取推荐列表
- **接口路径**：`GET /api/v1/recommendations`
- **功能**：分页获取推荐诗词列表
- **认证要求**：需要用户认证（可选，未认证时返回公开推荐）
- **请求参数**：
  - `user_id`: 用户ID（可选，从认证信息中获取，用于获取该用户的推荐）
  - `page`: 页码（默认1）
  - `page_size`: 每页数量（默认10，最大100）
  - `keyword`: 关键词搜索（可选）
  - `author`: 作者筛选（可选）
  - `dynasty`: 朝代筛选（可选）
  - `sort`: 排序方式（created_at_desc/created_at_asc，默认desc）
  - `my_recommendations`: 是否仅获取当前用户的推荐（true/false，默认false）
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,
    "page": 1,
    "page_size": 10,
    "items": [
      {
        "id": 1,
        "poem_title": "春晓",
        "poem_content": "春眠不觉晓...",
        "author": "孟浩然",
        "dynasty": "唐",
        "appreciation": "...",
        "created_at": "2024-01-01T10:00:00Z"
      }
    ]
  }
}
```

#### 3.2.3 获取推荐详情
- **接口路径**：`GET /api/v1/recommendations/{id}`
- **功能**：获取单条推荐记录的详细信息
- **认证要求**：需要用户认证（可选）
- **路径参数**：
  - `id`: 推荐记录ID
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "user_id": 1001,
    "user_name": "张三",
    "positive_prompt": "推荐一首关于春天的诗",
    "negative_prompt": "不要包含悲伤情绪",
    "image_url": "/uploads/images/2024/01/01/image.jpg",
    "image_description": "一幅描绘春天景色的山水画",
    "context": "用户喜欢唐诗",
    "poem_title": "春晓",
    "poem_content": "春眠不觉晓...",
    "author": "孟浩然",
    "dynasty": "唐",
    "appreciation": "...",
    "model_name": "gpt-4",
    "created_at": "2024-01-01T10:00:00Z"
  }
}
```

#### 3.2.4 搜索诗词
- **接口路径**：`GET /api/v1/poems/search`
- **功能**：根据关键词搜索诗词
- **请求参数**：
  - `q`: 搜索关键词（必填）
  - `page`: 页码
  - `page_size`: 每页数量
- **响应格式**：同推荐列表

#### 3.2.5 获取任务状态
- **接口路径**：`GET /api/v1/tasks/{task_id}`
- **功能**：查询推荐任务执行状态
- **路径参数**：
  - `task_id`: 任务ID
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "task_id": "12345",
    "status": "completed",
    "recommendation_id": 1,
    "progress": 100,
    "message": "推荐任务已完成"
  }
}
```

#### 3.2.6 获取用户个性化推荐
- **接口路径**：`GET /api/v1/users/{user_id}/recommendations`
- **功能**：获取指定用户的个性化推荐列表
- **认证要求**：需要用户认证，只能获取自己的推荐或公开推荐
- **路径参数**：
  - `user_id`: 用户ID
- **请求参数**：
  - `page`: 页码（默认1）
  - `page_size`: 每页数量（默认10，最大100）
  - `sort`: 排序方式（created_at_desc/created_at_asc，默认desc）
- **响应格式**：同推荐列表接口

#### 3.2.7 获取用户信息
- **接口路径**：`GET /api/v1/users/{user_id}`
- **功能**：获取用户基本信息
- **认证要求**：需要用户认证
- **路径参数**：
  - `user_id`: 用户ID
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1001,
    "username": "zhangsan",
    "nickname": "张三",
    "avatar": "/uploads/avatars/1001.jpg",
    "total_recommendations": 50,
    "total_favorites": 20,
    "created_at": "2024-01-01T10:00:00Z"
  }
}
```

#### 3.2.8 获取统计信息
- **接口路径**：`GET /api/v1/statistics`
- **功能**：获取系统统计信息
- **请求参数**：
  - `user_id`: 用户ID（可选，获取该用户的统计信息）
- **响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total_recommendations": 1000,
    "total_poems": 500,
    "authors_count": 50,
    "dynasties": ["唐", "宋", "元", "明", "清"],
    "user_recommendations": 50,
    "user_favorites": 20
  }
}
```

### 3.3 技术实现要求
- **框架选择**：Laravel 9.x / Laravel 10.x
- **功能要求**：
  - RESTful API设计规范
  - 统一的响应格式
  - **用户认证和授权**：
    - JWT Token认证（使用 `tymon/jwt-auth` 或 Laravel Sanctum）
    - 用户登录状态管理
    - 权限验证中间件（Laravel Policies / Gates）
    - 密码加密存储（Laravel Hash / bcrypt）
  - 参数验证
    - 使用Laravel Form Request进行验证
    - 正向提示词和图片至少提供一个的验证
    - 图片格式和大小验证
    - 用户输入验证
  - 图片上传处理
    - 使用Laravel Storage处理文件上传
    - 支持multipart/form-data格式
    - 图片文件接收和存储
    - 图片格式验证（JPG、PNG、WEBP等）
    - 图片大小限制（如最大10MB）
    - 图片安全扫描（可选）
  - 错误处理
    - 统一异常处理（Laravel Exception Handler）
    - 自定义异常类
  - API文档（Laravel API Documentation / Swagger）
  - 跨域支持（CORS中间件）
  - 请求限流（Laravel Rate Limiting）
  - 日志记录（Laravel Log）
  - 异步任务处理（Laravel Queue / Jobs）

### 3.4 安全要求
- **用户认证安全**：
  - JWT Token认证机制
  - Token过期时间设置
  - 密码强度要求
  - 密码加密存储（不可逆哈希）
  - 登录失败次数限制
  - 防止暴力破解
- **API安全**：
  - API密钥认证（可选）
  - 请求频率限制（按用户/IP）
  - 用户权限验证
- **数据安全**：
  - 输入参数验证和过滤
    - 提示词内容过滤（防止恶意输入）
    - 图片文件类型验证
    - 图片内容安全检查
    - SQL注入防护（Laravel Eloquent ORM自动防护）
    - XSS防护（Laravel Blade自动转义）
  - 用户数据隔离（用户只能访问自己的数据）
- **文件上传安全**：
  - 文件类型白名单
  - 文件大小限制
  - 文件名安全处理
  - 存储路径安全

---

## 4. 第三部分：系统运行Web后台管理系统

### 4.1 功能概述
提供Web管理界面，用于管理系统配置、查看和管理AI推荐内容、管理用户提示词等。

### 4.2 功能模块

#### 4.2.1 仪表盘（Dashboard）
- **功能**：系统概览和统计信息
- **内容**：
  - 推荐总数统计
  - 今日/本周/本月推荐数量
  - 用户总数统计
  - 活跃用户统计
  - 成功率统计
  - 模型使用统计
  - 热门作者/朝代统计
  - 系统运行状态

#### 4.2.2 推荐内容管理
- **功能列表**：
  - 推荐列表查看（支持分页、筛选、搜索）
    - 显示用户信息（用户名、昵称）
    - 显示正向提示词、负向提示词
    - 显示是否有图片输入
    - 支持按用户筛选
  - 推荐详情查看
    - 显示用户信息
    - 显示完整的正向/负向提示词
    - 显示图片和图片描述
    - 显示推荐结果和赏析
  - 推荐内容编辑
    - 可编辑正向/负向提示词
    - 可替换或删除图片
    - 可修改关联用户（管理员操作）
  - 推荐内容删除
  - 批量操作（批量删除、批量导出）
  - 推荐内容审核（可选）

#### 4.2.3 Agent程序配置管理
- **功能列表**：
  - AI模型配置管理
    - 添加/编辑/删除模型配置
    - 设置默认模型
    - API密钥管理
  - 提示词模板管理
    - 创建/编辑/删除提示词模板
    - 支持正向提示词模板和负向提示词模板
    - 模板变量配置
    - 模板类型设置（正向/负向/混合）
  - Agent运行参数配置
    - 超时时间设置
    - 重试次数设置
    - 默认参数配置

#### 4.2.4 任务管理
- **功能列表**：
  - 手动触发推荐任务
    - 支持输入正向提示词和负向提示词
    - 支持上传图片
    - 支持选择AI模型
    - 支持设置推荐数量等参数
  - 定时任务配置（可选）
  - 任务执行历史查看
    - 显示任务输入参数（正向/负向提示词、图片等）
    - 显示任务执行状态和结果
  - 任务执行日志查看
  - 任务状态监控

#### 4.2.5 用户管理
- **功能列表**：
  - 用户列表查看（支持分页、筛选、搜索）
    - 显示用户ID、用户名、昵称、注册时间等
    - 显示用户推荐数量、收藏数量等统计信息
  - 用户详情查看
    - 查看用户基本信息
    - 查看用户的推荐记录
    - 查看用户的收藏记录
  - 用户状态管理
    - 启用/禁用用户账户
    - 重置用户密码
  - 用户数据统计
    - 用户推荐统计
    - 用户活跃度统计

#### 4.2.6 用户提示词管理（未来功能）
- **功能列表**：
  - 用户提示词列表
  - 提示词统计分析
  - 热门提示词统计
  - 提示词分类管理

#### 4.2.7 系统设置
- **功能列表**：
  - 数据库配置
  - 系统参数配置
  - 日志级别设置
  - 备份和恢复
  - 用户权限管理（可选）

### 4.3 页面设计

#### 4.3.1 主要页面
1. **登录页面**：管理员登录
2. **仪表盘页面**：数据概览
3. **推荐管理页面**：列表、详情、编辑
4. **用户管理页面**：用户列表、用户详情、用户状态管理
5. **配置管理页面**：模型配置、提示词模板
6. **任务管理页面**：任务列表、执行日志
7. **系统设置页面**：系统参数配置

#### 4.3.2 UI/UX要求
- 响应式设计，支持PC和移动端
- 现代化UI设计
- 良好的用户体验
- 数据可视化（图表展示）

### 4.4 技术实现要求
- **前端技术**：
  - Vue.js / React
  - Element UI / Ant Design
  - Axios（HTTP请求）
  - ECharts（数据可视化）
- **后端技术**：
  - 使用Laravel框架实现（与API接口层共用或独立实现）
  - 需要额外的管理接口
  - Laravel Blade模板引擎（如需要服务端渲染）
- **功能要求**：
  - 用户认证和授权（Laravel Auth）
  - 会话管理（Laravel Session）
  - 文件上传（Laravel Storage）
    - 图片上传组件
    - 图片预览功能
    - 支持拖拽上传
  - 数据导出（Laravel Excel / Maatwebsite Excel）
    - Excel/CSV导出功能
  - 图片管理
    - 图片列表查看
    - 图片删除
    - 图片存储管理

---

## 5. 第四部分：客户端应用

### 5.1 功能概述
多平台客户端应用，为用户提供诗词推荐和赏析服务。

### 5.2 核心功能需求

#### 5.2.0 用户认证
- **功能**：用户登录、注册、退出
- **登录方式**：
  - 用户名/密码登录
  - 手机号/验证码登录（可选）
  - 第三方登录（微信、QQ等，可选）
- **注册功能**：
  - 用户名注册
  - 邮箱注册（可选）
  - 手机号注册（可选）
  - 密码强度验证
- **会话管理**：
  - Token存储和管理
  - 自动登录（记住密码）
  - 登录状态保持
- **用户信息**：
  - 显示当前登录用户信息
  - 用户头像和昵称显示

#### 5.2.1 诗词推荐
- **功能**：根据用户输入获取AI推荐的诗词
- **输入方式**：
  - **正向提示词输入**：
    - 文本输入框，支持多行输入
    - 占位符提示："描述您希望推荐的诗词特征，如主题、情感、风格等"
    - 示例："推荐一首关于春天的诗"、"表达思乡之情的诗词"
  - **负向提示词输入**（可选）：
    - 文本输入框，支持多行输入
    - 占位符提示："描述您不希望推荐的诗词包含的内容"
    - 示例："不要包含悲伤情绪"、"不要推荐现代诗"
  - **图片上传**（可选）：
    - 支持从相册选择、拍照、拖拽上传
    - 支持图片预览
    - 支持常见格式：JPG、PNG、WEBP
    - 图片大小限制提示
    - 支持图片裁剪和编辑（可选）
- **输入规则**：
  - 必须至少提供正向提示词或图片之一
  - 正向提示词和图片可以同时使用，提供更精确的推荐
  - 负向提示词可选，用于排除特定内容
- **用户关联**：
  - 推荐记录与当前登录用户关联
  - 未登录用户可浏览公开推荐，但无法创建推荐
- **交互流程**：
  1. 用户登录（如未登录，提示登录）
  2. 用户输入正向提示词或上传图片（或两者都提供）
  3. 可选输入负向提示词
  4. 可选输入上下文信息
  5. 提交请求（自动关联当前用户ID）
  6. 显示加载状态和进度提示
  7. 展示推荐结果（包含诗词内容、赏析、图片描述等）

#### 5.2.2 诗词浏览
- **功能列表**：
  - 推荐列表浏览
    - 全部推荐列表（公开推荐）
    - 我的推荐列表（仅当前用户的推荐）
    - 支持切换查看模式
  - 诗词详情查看
  - 分页加载
  - 下拉刷新
  - 上拉加载更多
  - 个性化推荐
    - 根据用户历史推荐偏好推荐相关内容
    - 推荐用户可能感兴趣的诗词

#### 5.2.3 诗词搜索
- **功能**：根据关键词搜索诗词
- **支持搜索**：
  - 诗词标题
  - 诗词内容
  - 作者
  - 朝代

#### 5.2.4 诗词收藏
- **功能**：收藏喜欢的诗词
- **功能点**：
  - 添加收藏
  - 取消收藏
  - 收藏列表查看
  - 收藏管理

#### 5.2.5 诗词分享
- **功能**：分享诗词到其他平台
- **支持平台**：
  - 微信
  - 微博
  - 复制链接
  - 生成图片分享

#### 5.2.6 个人中心
- **功能列表**：
  - 用户信息
    - 查看和编辑个人资料
    - 修改头像
    - 修改昵称
    - 修改密码
  - 我的推荐
    - 查看我创建的所有推荐
    - 推荐统计（总数、收藏数等）
  - 我的收藏
    - 收藏列表查看
    - 取消收藏
    - 收藏管理
  - 浏览历史（可选）
    - 最近浏览的推荐记录
  - 设置
    - 账号设置
    - 通知设置（可选）
    - 隐私设置（可选）
    - 关于应用

### 5.3 平台适配

#### 5.3.1 移动端（iOS/Android）
- **技术方案**：
  - 原生开发（Swift/Kotlin）
  - 跨平台框架（React Native / Flutter）
- **功能要求**：
  - 适配不同屏幕尺寸
  - 支持横竖屏切换
  - 离线缓存（可选）
  - 推送通知（可选）

#### 5.3.2 平板电脑
- **功能要求**：
  - 适配平板屏幕
  - 优化布局显示
  - 支持分屏显示

#### 5.3.3 PC端
- **技术方案**：
  - Web应用（响应式设计）
  - 桌面应用（Electron）
- **功能要求**：
  - 适配不同分辨率
  - 键盘快捷键支持
  - 更好的阅读体验

### 5.4 UI/UX设计要求
- **设计风格**：简洁、优雅、具有文化气息
- **色彩方案**：符合诗词文化主题
- **字体选择**：支持中文字体优化
- **交互体验**：
  - 流畅的动画效果
  - 友好的错误提示
  - 加载状态提示
  - 空状态提示

### 5.5 技术实现要求
- **用户认证**：
  - Token存储和管理（本地存储/Keychain）
  - 登录状态管理
  - 自动登录功能
  - 会话过期处理
- **API集成**：调用第二部分提供的API接口
- **图片处理**：
  - 图片选择和上传组件
  - 图片压缩和格式转换
  - 图片预览功能
  - 支持多平台图片选择（相册、拍照）
- **数据缓存**：
  - 本地缓存推荐内容
  - 用户信息缓存
  - 收藏列表缓存
- **网络处理**：网络错误处理、重试机制
- **性能优化**：图片懒加载、列表虚拟滚动
- **表单验证**：
  - 提示词输入验证
  - 图片格式和大小验证
  - 必填项校验（至少提供正向提示词或图片）
  - 登录表单验证

---

## 6. 数据库设计

### 6.1 数据库选型
- **推荐**：MySQL 8.0+ / PostgreSQL
- **备选**：SQLite（开发测试环境）

### 6.2 数据表设计

#### 6.2.1 用户表（users）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键，自增 |
| username | VARCHAR(50) | 用户名（唯一） |
| nickname | VARCHAR(100) | 昵称 |
| email | VARCHAR(100) | 邮箱（可选） |
| phone | VARCHAR(20) | 手机号（可选） |
| avatar | VARCHAR(500) | 头像路径 |
| password_hash | VARCHAR(255) | 密码哈希值 |
| status | TINYINT | 状态（1:正常 0:禁用） |
| last_login_at | DATETIME | 最后登录时间 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**字段说明**：
- `username` 必须唯一，用于登录
- `password_hash` 存储加密后的密码
- `status` 用于账户状态管理

#### 6.2.2 推荐记录表（recommendations）
见2.3.1节

#### 6.2.3 模型配置表（model_configs）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| name | VARCHAR(100) | 模型名称 |
| api_provider | VARCHAR(50) | API提供商 |
| api_endpoint | VARCHAR(200) | API端点 |
| api_key | VARCHAR(200) | API密钥（加密存储） |
| default_params | JSON | 默认参数 |
| is_default | TINYINT | 是否默认模型 |
| status | TINYINT | 状态（1:启用 0:禁用） |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### 6.2.4 提示词模板表（prompt_templates）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| name | VARCHAR(100) | 模板名称 |
| positive_template | TEXT | 正向提示词模板内容 |
| negative_template | TEXT | 负向提示词模板内容（可选） |
| variables | JSON | 变量定义 |
| type | VARCHAR(50) | 模板类型（positive/negative/both） |
| is_default | TINYINT | 是否默认 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**字段说明**：
- `positive_template` 和 `negative_template` 至少有一个不为空
- `type` 表示模板类型：positive（仅正向）、negative（仅负向）、both（同时包含）

#### 6.2.5 任务执行记录表（task_logs）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID（外键，关联users表） |
| task_type | VARCHAR(50) | 任务类型 |
| positive_prompt | TEXT | 正向提示词 |
| negative_prompt | TEXT | 负向提示词 |
| image_path | VARCHAR(500) | 图片文件路径（如适用） |
| status | TINYINT | 执行状态 |
| result_id | BIGINT | 结果记录ID |
| error_message | TEXT | 错误信息 |
| execution_time | INT | 执行时间（毫秒） |
| created_at | DATETIME | 创建时间 |

#### 6.2.6 用户收藏表（user_favorites）
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键 |
| user_id | BIGINT | 用户ID（外键，关联users表） |
| recommendation_id | BIGINT | 推荐记录ID（外键，关联recommendations表） |
| created_at | DATETIME | 收藏时间 |

**字段说明**：
- `user_id` 和 `recommendation_id` 组合唯一，防止重复收藏

### 6.3 索引设计
- `users`: 在 `username` 上建立唯一索引，在 `email` 上建立索引（如使用邮箱登录）
- `recommendations`: 
  - 在 `user_id` 上建立索引（用于查询用户推荐）
  - 在 `created_at` 上建立索引
  - 在 `author` 上建立索引
  - 在 `dynasty` 上建立索引
  - 在 `user_id` 和 `created_at` 上建立联合索引（用于用户推荐列表查询）
- `task_logs`: 
  - 在 `user_id` 上建立索引
  - 在 `created_at` 上建立索引
  - 在 `status` 上建立索引
- `user_favorites`: 
  - 在 `user_id` 上建立索引
  - 在 `recommendation_id` 上建立索引
  - 在 `user_id` 和 `recommendation_id` 上建立联合唯一索引

---

## 7. 技术栈建议

### 7.1 后端技术栈
- **编程语言**：PHP 7.4+ / PHP 8.0+
- **Web框架**：Laravel 9.x / Laravel 10.x
- **数据库**：MySQL 8.0+ / PostgreSQL
- **ORM**：Laravel Eloquent ORM
- **API文档**：Laravel API Documentation / Swagger (L5-Swagger)
- **任务队列**：Laravel Queue（Redis / Database驱动）
- **缓存**：Redis / Memcached
- **认证**：Laravel Sanctum / Tymon JWT Auth
- **文件存储**：Laravel Storage（本地 / S3 / OSS）

### 7.2 Agent程序技术栈
- **编程语言**：PHP 7.4+ / PHP 8.0+
- **命令行框架**：Symfony Console
- **HTTP客户端**：Guzzle HTTP
- **图片处理**：Intervention Image / GD扩展
- **数据库**：PDO / Laravel Database
- **日志**：Monolog

### 7.3 前端技术栈（Web管理后台）
- **框架**：Vue.js 3 / React
- **UI组件库**：Element Plus / Ant Design
- **状态管理**：Vuex / Redux
- **HTTP客户端**：Axios
- **构建工具**：Vite / Webpack

### 7.4 客户端技术栈
- **移动端**：React Native / Flutter
- **PC Web**：Vue.js / React（响应式）
- **桌面应用**：Electron（可选）

### 7.5 开发工具
- **版本控制**：Git
- **代码规范**：PHP CS Fixer, ESLint
- **测试框架**：PHPUnit, Jest
- **API测试**：Postman
- **容器化**：Docker（可选）
- **依赖管理**：Composer（PHP）

---

## 8. 开发计划

### 8.1 第一阶段：AI诗词推荐Agent（当前阶段）
- [ ] 项目初始化
- [ ] 数据库设计和创建
- [ ] AI大模型API调研和集成
- [ ] 命令行程序开发
- [ ] 数据存储功能实现
- [ ] 单元测试
- [ ] 文档编写

### 8.2 第二阶段：API接口开发
- [ ] Laravel项目初始化
- [ ] 数据库模型实现（Eloquent ORM）
- [ ] API接口开发
- [ ] API文档生成
- [ ] 接口测试
- [ ] 性能优化

### 8.3 第三阶段：Web后台管理系统
- [ ] 前端项目初始化
- [ ] Laravel管理接口开发
- [ ] 前端页面开发
- [ ] 功能测试
- [ ] UI优化

### 8.4 第四阶段：客户端开发
- [ ] 客户端架构设计
- [ ] 核心功能开发
- [ ] 多平台适配
- [ ] 用户体验优化
- [ ] 测试和发布

---

## 9. 非功能性需求

### 9.1 性能要求
- API响应时间 < 500ms（数据库查询）
- 支持并发用户数 > 100
- 数据库查询优化

### 9.2 可用性要求
- 系统可用性 > 99%
- 错误处理和恢复机制
- 日志记录和监控

### 9.3 安全性要求
- 数据加密存储（敏感信息）
- API安全防护
- 输入验证和过滤
- 防止SQL注入和XSS攻击

### 9.4 可维护性要求
- 代码规范统一
- 完善的注释和文档
- 模块化设计
- 易于扩展

---

## 10. 风险评估

### 10.1 技术风险
- AI API调用失败或限流
- 数据库性能瓶颈
- 跨平台兼容性问题

### 10.2 业务风险
- AI推荐质量不稳定
- 用户需求变化
- 竞品分析

### 10.3 应对措施
- 实现重试机制和降级方案
- 数据库优化和缓存策略
- 充分测试和用户反馈收集

---

## 11. 附录

### 11.1 术语表
- **Agent**：智能代理程序，能够自主执行任务
- **Prompt**：提示词，用于指导AI模型生成内容
- **API**：应用程序编程接口
- **RESTful**：一种API设计风格

### 11.2 参考资料
- AI大模型API文档
- RESTful API设计规范
- 数据库设计最佳实践
- Laravel官方文档

---

**文档版本**：v2.0 (PHP版本)  
**创建日期**：2024年  
**最后更新**：2024年

